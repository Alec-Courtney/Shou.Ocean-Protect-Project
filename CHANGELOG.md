# 更新日志

---
## V4.6 更新日志 (2025-08-25)

本次更新聚焦于数据推送完整性、前端实时体验、环境配置灵活性以及自动化测试与文档完善。

*   **后端增强 - 实时推送精细化**:
    *   `backend/main.py` 现在会在写入预警时携带数据库 `id` 并广播新的 `warning_created` 事件，同时推送最新的当日预警总数，避免前端额外轮询。
    *   `/api/warnings/*` 接口（`backend/api/warnings.py`）统一返回 `id` 与 `boat_name` 字段，便于前端展示与去重。
    *   通过环境变量 `OCEAN_PROTECT_DB_PATH`（`backend/database_utils.py`、`Scripts/database.py`）即可切换 SQLite 位置，测试与部署更加灵活。

*   **前端优化 - 去重与安全展示**:
    *   `frontend/js/main.js` 增加 `warning_created` 事件监听、预警缓存与历史模式隔离逻辑，避免实时推送干扰历史查询。
    *   统一处理船只名称/ID，更新地图标签与弹窗，并对所有字段进行 HTML 转义，同时仅在经纬度有效时聚焦地图，提示音播放前会重置进度。

*   **测试与文档**:
    *   新增 `tests/test_warnings_api.py`，基于临时数据库验证预警 API 的新增字段；`requirements.txt` 加入 `pytest` 与 `httpx`。
    *   `Docs/API.md`、`Docs/UpgradePlan.md`、`README.md` 分别更新接口说明、最新进展与“运行测试”章节，保持文档同步。

---
## V4.5 更新日志 (2025-08-16)

本次更新对预警系统的核心逻辑进行了重构，旨在提供更精确、更有层次感的预警信息。

*   **核心功能重构 - 预警等级体系**:
    *   重新定义了预警等级，将“已越界”和“预测性越界”明确区分，使预警更具指导性。
    *   **新预警等级定义**:
        *   **等级 1 (最高)**: **已越界**。船只当前物理位置已在许可渔区之外。
        *   **等级 2 (次高)**: **即将越界**。根据 `config.json` 中配置的较短时间（默认为900秒）预测，船只即将越界。
        *   **等级 3 (普通)**: **越界风险**。根据 `config.json` 中配置的较长时间（默认为3600秒）预测，船只存在越界风险。
        *   **等级 0**: **安全**。

*   **后端逻辑调整**:
    *   重写了 `Scripts/WarningAnalysis.py` 中的核心分析函数，以实现上述新的预警判断逻辑。

*   **配置项更新**:
    *   相应地调整了 `config.json` 文件中的 `warning_levels_seconds` 配置项，以匹配新的预警等级体系。

*   **地图底图更换**:
    *   将默认的 OpenStreetMap 街道地图更换为 **Esri World Imagery** 卫星地图，以提供更适合海洋项目的视觉背景。

## V4.4 更新日志 (2025-08-16)

本次更新对前端UI进行了全面的重构与优化，提升了信息展示的直观性和紧凑性。

*   **UI重构 - 固定右侧边栏**:
    *   移除了右侧边栏的可折叠功能，改为固定显示模式，确保船只列表、实时状态和预警信息等关键模块始终可见。
    *   相应地，隐藏了右侧边栏的展开/折叠切换按钮，简化了界面交互。

*   **UI优化 - 布局与尺寸**:
    *   对右侧边栏的整体宽度、内部各面板的间距、内边距及字体大小进行了精细化调整，使整体布局更加紧凑，显著提高了信息密度。
    *   为“船只列表”面板设置了固定的高度，确保其能稳定显示约三条船只信息，并保留了独立的滚动条功能，解决了其高度被下方预警列表动态挤压的问题。

*   **功能增强 - 船只列表仅显示在线船只**:
    *   新增了船只在线状态判断机制。现在，船只列表将只显示在指定时间内（默认为60秒）有过数据更新的“在线”船只，自动隐藏已失联的船只，使列表更加简洁有效。
    *   离线超时时间已添加到 `config.json` 文件中 (`offline_timeout_seconds`)，方便用户根据实际需求进行调整。

*   **功能升级 - 动态预警列表**:
    *   将原有的单一预警弹窗，升级为动态预警列表。新的预警会实时出现在列表顶部，旧的预警则自动下移，形成一个清晰的预警时间线。
    *   预警列表会自动管理显示数量，避免信息无限增长导致界面溢出。
    *   将预警信息中显示的经纬度坐标精度提升至5位小数，以提供更精确的位置信息。

*   **功能调整 - 移除选中船只的实时轨迹**:
    *   为了简化实时监控视图，移除了在列表中选中船只时，地图上自动绘制其近期灰色轨迹线的功能。
    *   此改动不影响“历史查询”模块中的历史轨迹回放功能。

*   **UI优化 - 预测轨迹视觉增强**:
    *   优化了预测轨迹的显示方式，将其从单一虚线改为由多段线段构成。
    *   离船只越远的线段透明度越低，以更直观地体现预测的“不确定性”，尤其适用于更长的预警时间。

*   **功能增强 - 预警提示音**:
    *   新增了声音提醒功能。当有新的预警信息出现时，系统会自动播放提示音，确保用户能第一时间注意到。

*   **体验优化 - 地图视角自动聚焦**:
    *   伴随声音提示，地图视角会自动平滑移动并聚焦到触发预警的船只上, 实现了快速定位。

*   **功能增强 - 新增预警统计栏**:
    *   在左侧边栏新增了一个“预警统计”模块，提供更直观的数据洞察。
    *   默认情况下，该模块显示当天所有船只触发的预警总次数。
    *   当用户执行历史查询时，统计栏会自动切换，显示当前查询时间段内所选船只的预警次数。
    *   清除查询后，统计栏会恢复显示当天的预警总数。

## V4.3 更新日志 (2025-08-16)

本次更新主要聚焦于前端UI/UX的重大改进和历史查询功能的增强。

*   **UI优化 - 可折叠双侧边栏**:
    *   引入了全新的可折叠双侧边栏布局，最大化地图显示区域，提升用户体验。
    *   **右侧边栏**: 集中显示**船只列表**、**实时状态 (当前选中)**和**服务器连接状态**。
    *   **左侧边栏**: 集中显示**历史查询**和**预警信息列表**。
    *   侧边栏切换按钮在收起时固定在屏幕边缘，展开时随侧边栏平滑移动。

*   **功能增强 - 历史查询模块重构**:
    *   **独立船只选择**: 历史查询功能不再依赖实时船只列表的选中状态，新增独立的船只选择器，可从数据库中选择任意船只进行查询。
    *   **“所有警报”查询**: 在船只选择器中集成了“所有船只”选项，允许用户查询指定时间段内所有船只的历史警报记录，并仅在预警信息列表中显示，不在地图上绘图。
    *   **后端API支持**: 新增 `/api/all_warnings` API 端点，支持前端查询所有历史警报。
    *   **样式统一**: 历史查询部分的船只选择器和时间输入框的样式已统一，保持视觉一致性。

---

## V4.2 更新日志 (2025-08-15)

本次更新是一次综合性的升级，包含了对系统性能、稳定性和核心功能的全面优化与增强。

*   **功能增强 - 新增船只名称 (`boat_name`)**:
    *   系统现在支持为每艘船只记录和更新名称。数据从模拟器发出，由后端API接收并存入数据库。

*   **功能增强 - 智能预警记录**:
    *   重构了后端的预警记录逻辑。现在系统只会在预警**首次触发**或**等级发生变化**时记录一次，避免了因持续处于预警状态而产生大量冗余的记录，极大地优化了历史预警数据的质量和存储效率。

*   **UI优化 - 历史预警点图标**:
    *   优化了历史查询的可视化效果。现在地图上的历史预警点将以其对应预警等级的**PNG图标**显示，取代了原有的红色圆圈，与实时监控的视觉风格保持一致。

*   **性能优化 - 数据库查询加速**:
    *   为数据库中的 `gps_positions` 和 `warnings` 表的关键字段 (`boat_id`, `timestamp`) 添加了**索引**。此项优化能将历史数据查询速度提升数个数量级，是保障系统长期稳定运行的核心。

*   **性能优化 - 后端历史数据抽稀**:
    *   在后端查询历史轨迹的API中增加了**数据抽稀**逻辑。当查询返回的数据点过多时，系统会自动进行采样，确保前端在渲染超长轨迹时不会卡顿或崩溃。

*   **性能优化 - 前端图层管理**:
    *   重构了前端地图渲染逻辑，严格遵循“**创建一次，持续更新**”的原则，通过复用地图图层而非重复创建来更新船只状态，显著提升了多船只场景下的地图流畅度。

*   **架构优化 - 可配置日志系统**:
    *   移除了硬编码的日志配置，实现了基于 `config.json` 文件的**动态日志级别控制**。现在可以方便地在生产环境和开发环境间切换日志详细程度，是项目走向成熟的重要一步。

## V4.1 更新日志 (2024-08-14)

*   **性能优化 - 前端节流**: 在前端 `main.js` 中引入了 **throttle (节流)** 机制，将地图上船只位置的更新频率限制在每秒一次。
*   **性能优化 - 后端推送控制**: 在后端 `server.py` 中增加了时间戳缓存，现在服务器只在距离上次推送超过1秒时，才会通过WebSocket向客户端发送新的GPS数据。
*   **UI优化 - 船只列表高亮**: 重新设计了船只列表选中项的CSS样式。
*   **UI优化 - 面板布局与样式**: 优化了多个UI面板的布局和样式。
*   **UI优化 - 地图交互与标签显示**: 实现了点击地图图标选中船只，并增加了显示/隐藏船只标签的功能。
*   **架构优化 - 后端异步处理**: 在后端 `server.py` 中引入了 **FastAPI 的后台任务 (BackgroundTasks)**，实现了数据接收与处理的解耦。
