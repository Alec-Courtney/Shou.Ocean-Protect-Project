# 系统性能优化计划 (V4.2)

本文档记录了针对“渔船离境智能预警系统” V4.1 版本后续的性能优化计划、设计方案与实施状态。

---

## 第一阶段：核心体验与稳定性 (已完成)

**目标**: 解决核心体验与稳定性问题，确保系统在数据量增大后依然能流畅运行。

### 1. 数据库索引优化 (Database Indexing)
- **状态**: ✅ **已完成**
- **目标**: 根本性提升历史轨迹和预警的查询速度，防止因数据量增长导致的查询超时。
- **实施文件**: `Scripts/database.py`
- **方案**:
    1. 在 `init_db` 函数中，于 `CREATE TABLE gps_positions` 语句之后，添加创建 `boat_id` 和 `timestamp` 字段的索引。
    2. 同样，为 `warnings` 表的 `boat_id` 和 `timestamp` 字段创建相应索引。
    3. 使用 `CREATE INDEX IF NOT EXISTS` 语句确保脚本可重复运行。

### 2. 历史轨迹数据抽稀 (Trajectory Data Thinning)
- **状态**: ✅ **已完成**
- **目标**: 防止在查询长时间范围历史轨迹时，因返回过多数据点而导致前端浏览器渲染卡顿甚至崩溃。
- **实施文件**: `server.py`
- **方案**:
    1. 在历史轨迹查询API端点 `/api/boats/{boat_id}/history` 中。
    2. 在从数据库查询出完整轨迹数据后，加入数据抽稀逻辑。
    3. 设置一个数据点数量阈值 `MAX_POINTS = 1000`。若查询结果超过该阈值，则进行步长采样，将数据点数量降至阈值以下再返回给前端。

### 3. Leaflet图层管理优化 (Leaflet Layer Management)
- **状态**: ✅ **已完成**
- **目标**: 优化地图上船只图层的更新方式，从“销毁并重建”改为“原地更新”，大幅减少DOM操作，提升多船只同时移动时的地图流畅度。
- **实施文件**: `frontend/js/main.js`
- **方案**:
    1. 重构 `updateBoatData` 函数，将其逻辑拆分为 `createBoatLayers` (用于新船只) 和 `updateBoatData` (用于更新现有船只)。
    2. 严格遵循“创建一次，持续更新”的原则：
        - 新船只首次出现时，一次性创建其 `marker`, `polyline` 等所有图层并存入 `boatsData` 对象。
        - 后续数据更新时，直接从 `boatsData` 获取已有图层对象，调用 `.setLatLng()`, `.setIcon()`, `.setLatLngs()` 等方法更新其属性，而不是移除旧图层再创建新图层。

### 4. 可配置的日志记录 (Configurable Logging)
- **状态**: ✅ **已完成**
- **目标**: 引入专业的日志管理，替换 `print()` 语句，并允许通过配置文件控制日志的详细程度。
- **实施文件**: `server.py`, `config.json`
- **方案**:
    1. 在 `config.json` 中增加 `logging` 配置项，允许设置 `level` (如 "INFO", "DEBUG")。
    2. 在 `server.py` 中，移除顶层的静态 `logging.basicConfig`。
    3. 创建一个新的 `setup_logging` 函数，该函数能根据传入的级别字符串来配置日志系统。
    4. 在服务器启动事件 `startup_event` 中，于加载配置后调用 `setup_logging` 函数，实现日志级别的动态配置。

---

## 未来优化项 (Backlog)

以下是原始计划中提出、但尚未在第一阶段实施的优化点，留待未来版本考虑。

### 数据库性能优化
- **批量插入**: 优化GPS数据写入数据库的方式，考虑使用批量插入来减少I/O开销。
- **数据库连接池**: (优先级低) 对于SQLite非必要，但若未来迁移至其他数据库则需考虑。

### 预警分析算法优化
- **算法效率提升**: 审查并优化预测性预警的几何计算。
- **计算结果缓存**: (优先级低) 针对特定可缓存的计算引入缓存机制。

### 前端渲染与交互优化
- **Web Workers**: (优先级中) 对于更复杂的客户端计算，可使用Web Workers避免UI阻塞。

### 网络通信效率优化
- **增量数据推送**: (优先级高) 优化WebSocket，只推送状态变化的船只数据。
- **WebSocket数据压缩**: (优先级低) 对WebSocket传输的数据进行压缩。

### 系统资源利用优化
- **并发处理优化**: (优先级中) 审查FastAPI后台任务机制，或引入Celery等专业任务队列。
