# 项目：渔船离境智能预警系统 (V4.2 - 核心优化与功能增强版)

---
## 1. V4.3 更新日志 (2025-08-16)

本次更新主要聚焦于前端UI/UX的重大改进和历史查询功能的增强。

*   **UI优化 - 可折叠双侧边栏**:
    *   引入了全新的可折叠双侧边栏布局，最大化地图显示区域，提升用户体验。
    *   **右侧边栏**: 集中显示**船只列表**、**实时状态 (当前选中)**和**服务器连接状态**。
    *   **左侧边栏**: 集中显示**历史查询**和**预警信息列表**。
    *   侧边栏切换按钮在收起时固定在屏幕边缘，展开时随侧边栏平滑移动。

*   **功能增强 - 历史查询模块重构**:
    *   **独立船只选择**: 历史查询功能不再依赖实时船只列表的选中状态，新增独立的船只选择器，可从数据库中选择任意船只进行查询。
    *   **“所有警报”查询**: 在船只选择器中集成了“所有船只”选项，允许用户查询指定时间段内所有船只的历史警报记录，并仅在预警信息列表中显示，不在地图上绘图。
    *   **后端API支持**: 新增 `/api/all_warnings` API 端点，支持前端查询所有历史警报。
    *   **样式统一**: 历史查询部分的船只选择器和时间输入框的样式已统一，保持视觉一致性。

---

## 2. V4.2 更新日志 (2025-08-15)

本次更新是一次综合性的升级，包含了对系统性能、稳定性和核心功能的全面优化与增强。

*   **功能增强 - 新增船只名称 (`boat_name`)**:
    *   系统现在支持为每艘船只记录和更新名称。数据从模拟器发出，由后端API接收并存入数据库。

*   **功能增强 - 智能预警记录**:
    *   重构了后端的预警记录逻辑。现在系统只会在预警**首次触发**或**等级发生变化**时记录一次，避免了因持续处于预警状态而产生大量冗余的记录，极大地优化了历史预警数据的质量和存储效率。

*   **UI优化 - 历史预警点图标**:
    *   优化了历史查询的可视化效果。现在地图上的历史预警点将以其对应预警等级的**PNG图标**显示，取代了原有的红色圆圈，与实时监控的视觉风格保持一致。

*   **性能优化 - 数据库查询加速**:
    *   为数据库中的 `gps_positions` 和 `warnings` 表的关键字段 (`boat_id`, `timestamp`) 添加了**索引**。此项优化能将历史数据查询速度提升数个数量级，是保障系统长期稳定运行的核心。

*   **性能优化 - 后端历史数据抽稀**:
    *   在后端查询历史轨迹的API中增加了**数据抽稀**逻辑。当查询返回的数据点过多时，系统会自动进行采样，确保前端在渲染超长轨迹时不会卡顿或崩溃。

*   **性能优化 - 前端图层管理**:
    *   重构了前端地图渲染逻辑，严格遵循“**创建一次，持续更新**”的原则，通过复用地图图层而非重复创建来更新船只状态，显著提升了多船只场景下的地图流畅度。

*   **架构优化 - 可配置日志系统**:
    *   移除了硬编码的日志配置，实现了基于 `config.json` 文件的**动态日志级别控制**。现在可以方便地在生产环境和开发环境间切换日志详细程度，是项目走向成熟的重要一步。

## 3. V4.1 更新日志 (2024-08-14)

*   **性能优化 - 前端节流**: 在前端 `main.js` 中引入了 **throttle (节流)** 机制，将地图上船只位置的更新频率限制在每秒一次。
*   **性能优化 - 后端推送控制**: 在后端 `server.py` 中增加了时间戳缓存，现在服务器只在距离上次推送超过1秒时，才会通过WebSocket向客户端发送新的GPS数据。
*   **UI优化 - 船只列表高亮**: 重新设计了船只列表选中项的CSS样式。
*   **UI优化 - 面板布局与样式**: 优化了多个UI面板的布局和样式。
*   **UI优化 - 地图交互与标签显示**: 实现了点击地图图标选中船只，并增加了显示/隐藏船只标签的功能。
*   **架构优化 - 后端异步处理**: 在后端 `server.py` 中引入了 **FastAPI 的后台任务 (BackgroundTasks)**，实现了数据接收与处理的解耦。

---

## 3. 项目简介

本项目是一个高效、实时的渔船离境智能预警系统。它已从一个单点监控工具全面升级为一个**多源数据处理与持久化平台**。系统现在可以接收来自任意数量船只的GPS数据，在地图上进行实时可视化，计算并发出预警，同时记录所有船只的历史轨迹和预警信息，并提供强大的查询功能。

---

## 4. 核心功能

*   **多船实时监控**: 在地图上实时显示多艘船的当前位置、速度、航向和预警状态。
*   **多级智能预警**:
    *   **越界预警**: 当船只已在渔区外时，触发最高等级警报。
    *   **预测性预警**: 根据当前航速和方向，预测未来轨迹，若轨迹将越界，则提前发出预警。
*   **数据持久化与查询**:
    *   **历史轨迹**: 自动存储所有船只的航行数据，并可按船只和时间范围查询历史轨迹。
    *   **预警记录**: 自动记录所有预警事件，并可按船只和时间范围查询历史预警。
*   **可视化分析**:
    *   **实时轨迹**: 绘制船只的近期航行路径（灰色实线）。
    *   **预测轨迹**: 实时标绘船只的未来预测路径（红色虚线）。
    *   **动态图标**: 船只图标根据预警等级（0-3级）变化，状态直观易懂。
*   **高性能与可扩展架构**:
    *   **HTTP API接收**: 放弃了原有的串口直连方式，改用标准的HTTP API接收数据，极大提升了系统的可扩展性和兼容性。
    *   **数据库支持**: 后端集成SQLite数据库，高效管理海量历史数据。
    *   **前后端分离**: 清晰的客户端-服务器架构，通过WebSocket进行实时数据推送。

---

## 5. 系统架构 (V4.2) (2025-08-15)

系统采用经典的 **客户端-服务器 (C/S)** 架构，并引入了数据库作为数据中心。

1.  **后端 (Python FastAPI Server)**:
    *   基于 **FastAPI** 框架，负责核心业务逻辑。
    *   **数据入口**: 提供 `POST /api/gps_data` 接口，用于接收任意来源（如船载终端、其他服务器）发送的JSON格式GPS数据。
    *   **数据库模块 (`database.py`)**: 使用 **SQLite** 数据库，负责创建表结构并存储所有船只信息、GPS位置和预警记录。
    *   **查询服务**: 提供一系列API（如 `/api/boats`, `/api/boats/{id}/history`）以支持前端的数据查询需求。
    *   **实时推送**: 使用 **Socket.IO** 通过WebSocket将处理后的实时数据（位置、预警等）主动广播给所有连接的前端客户端。

2.  **前端 (Web Application)**:
    *   纯粹的Web应用，由 HTML, CSS, 和 JavaScript 构成。
    *   使用 **Leaflet.js** 开源库展示地图和地理信息。
    *   通过 WebSocket 接收后端广播的数据，动态更新多艘船只的位置、图标和状态。
    *   提供交互式UI，包括船只列表和历史查询面板，用户可通过UI调用后端的查询API并在地图上展示结果。

3.  **数据流**:
    *   `GPS设备 -> HTTP POST -> 后端API (加入后台任务) -> [异步处理: 数据库存储 & 实时分析 -> WebSocket推送] -> 前端UI更新`

---

## 6. 环境准备

1.  **Python环境**: 推荐使用 [Miniconda](https://docs.conda.io/en/latest/miniconda.html) 或 [Anaconda](https://www.anaconda.com/)。
2.  **安装Python依赖**:
    ```bash
    pip install fastapi uvicorn python-socketio websockets pyserial geopandas shapely requests
    ```
    *   **注意**: 如果 `geopandas` 安装遇到问题，请尝试 `conda install geopandas`。

---

## 7. 操作说明

### **步骤 1: 配置与初始化**

1.  **配置渔区 (首次运行需要)**:
    *   打开 `config.json` 文件。
    *   在 `monitoring_parameters` 部分，将 `default_fishing_zones` 的值修改为您的可捕鱼区Shapefile文件的**正确路径**。
2.  **转换地理数据 (首次运行需要)**:
    *   打开一个终端，运行以下命令将Shapefile转换为前端可用的GeoJSON格式：
        ```bash
        python Scripts/convert_geojson.py
        ```
    *   此脚本会将生成的 `fishing_zones.geojson` 文件保存到 `frontend/data/` 目录。

### **步骤 2: 启动后端服务器**

1.  打开一个终端。
2.  运行后端服务器：
    ```bash
    python server.py
    ```
    *   服务器首次启动时，会自动在项目根目录创建 `database.db` 文件。
    *   保持此终端窗口打开。

### **步骤 3: 打开前端Web页面**

1.  在您的Web浏览器中直接打开 `frontend/index.html` 文件。
    *   页面加载后会自动连接到后端服务器。

### **步骤 4: 启动手动GPS模拟器 (用于测试)**

1.  打开**另一个新的终端**。
2.  运行新版的手动GPS模拟器：
    ```bash
    python Scripts/ManualGPSSimulator.py
    ```
3.  **操作模拟器**:
    *   在模拟器GUI中，可以为不同的船只设置 `船只ID` (例如 `BOAT-001`) 和 `船只名称`。
    *   点击“开始发送”，模拟器会通过HTTP请求将数据发送到后端。
    *   您可以打开多个模拟器实例，或在同一个模拟器中更改ID后重启发送，来模拟多艘船。

### **步骤 5: 在前端进行交互**

1.  **实时查看**: 在前端页面的“船只列表”中，您会看到所有正在发送数据的船只。
2.  **选择船只**: 点击列表中的任意船只ID，地图会自动聚焦到该船，右侧的状态面板会显示其详细信息。
3.  **查询历史**:
    *   选中一艘船。
    *   在“历史查询”面板中选择开始和结束时间。
    *   点击“查询”按钮，该船的历史轨迹和历史预警点将会被绘制在地图上。

---

## 8. 故障排除

*   **WebSocket连接失败**:
    *   确保后端服务器 (`python server.py`) 正在运行且没有报错。
    *   检查防火墙设置，确保 `http://localhost:8000` 可以被访问。
*   **`ModuleNotFoundError`**: 确保所有Python依赖都已通过 `pip install` 正确安装。
*   **GeoJSON文件未找到**: 确保您已成功运行 `python Scripts/convert_geojson.py` 脚本。
*   **HTTP请求失败 (模拟器)**: 确保后端服务器正在运行，并且模拟器中的服务器地址 (`http://localhost:8000/api/gps_data`) 是正确的。
