# 项目：渔船离境智能预警系统 (V4.5)

---

## 更新历史

详细的更新历史请参见 [CHANGELOG.md](CHANGELOG.md)。

---

## 1. 项目简介

本项目是一个高效、实时的渔船离境智能预警系统。它已从一个单点监控工具全面升级为一个**多源数据处理与持久化平台**。系统可以接收来自任意数量船只的GPS数据，在地图上进行实时可视化，根据可配置的规则计算并发出多级预警，同时将所有船只的历史轨迹和预警信息存入数据库，并提供强大的历史数据查询与统计功能。

---

## 2. 核心功能

*   **多船实时监控**: 在高精度卫星地图上实时显示多艘船的当前位置、速度、航向和预警状态。
*   **多级智能预警**:
    *   **等级 1 (已越界)**: 当船只物理位置越出许可渔区时，触发最高等级警报。
    *   **等级 2 (即将越界)**: 根据当前航速和方向，预测船只在较短时间（可配置）内的轨迹将越界。
    *   **等级 3 (越界风险)**: 预测船只在较长时间（可配置）内的轨迹存在越界风险。
*   **数据持久化与查询**:
    *   **历史轨迹**: 自动存储所有船只的航行数据，并可按船只和时间范围查询历史轨迹。
    *   **预警记录**: 智能记录所有预警事件（仅在首次触发或等级变化时记录），并可查询历史预警。
*   **丰富的数据可视化**:
    *   **动态图标**: 船只图标根据预警等级（0-3级）实时变化，状态直观易懂。
    *   **预测轨迹**: 实时标绘船只的未来预测路径，并以渐变透明度直观体现预测的“不确定性”。
    *   **历史数据回放**: 在地图上绘制指定船只的历史轨迹线和历史预警点图标。
*   **即时用户提醒**:
    *   **动态预警列表**: 新的预警会实时出现在列表顶部，形成清晰的预警时间线。
    *   **声音提示**: 当有新的预警出现时，系统会自动播放提示音。
    *   **地图自动聚焦**: 伴随声音提示，地图视角会自动平滑移动并聚焦到触发预警的船只上。
*   **数据统计与洞察**:
    *   **预警统计栏**: 实时显示当日预警总数，或在历史查询时显示查询范围内的预警数。
*   **高性能与可扩展架构**:
    *   **HTTP API接收**: 采用标准的HTTP API接收数据，极大提升了系统的可扩展性和兼容性。
    *   **数据库支持**: 后端集成SQLite数据库，并通过索引优化海量历史数据的查询性能。
    *   **前后端分离**: 清晰的客户端-服务器架构，通过WebSocket进行高效的实时数据推送。
    *   **性能优化**: 采用后端数据抽稀、前端节流（Throttle）和Canvas渲染等多种技术，确保在多船只场景下系统依然流畅。

---

## 3. 系统架构

系统采用经典的 **客户端-服务器 (C/S)** 架构，并引入了数据库作为数据中心。

1.  **后端 (Python FastAPI & Socket.IO Server)**:
    *   基于 **FastAPI** 框架处理所有HTTP API请求，提供数据查询服务。
    *   基于 **Socket.IO** (运行在ASGI模式) 处理WebSocket连接，负责向所有前端客户端实时广播更新。
    *   **数据入口**: 提供 `POST /api/gps_data` 接口，接收JSON格式的GPS数据，并利用FastAPI的**后台任务(BackgroundTasks)**进行异步处理，实现API的快速响应。
    *   **核心分析模块 (`WarningAnalysis.py`)**: 负责实时的预警等级计算和预测轨迹生成。
    *   **数据库模块 (`database.py`)**: 使用 **SQLite** 数据库，负责存储船只信息、GPS位置和预警记录，并包含索引优化。

2.  **前端 (Web Application)**:
    *   纯粹的Web应用，由 HTML, CSS, 和 JavaScript 构成。
    *   使用 **Leaflet.js** 开源库展示地图和地理信息，并利用其Canvas渲染器提升性能。
    *   通过 **Socket.IO客户端** 接收后端广播的数据，动态更新多艘船只的位置、图标和状态。
    *   提供交互式UI，包括固定的双侧边栏布局，用于历史查询、预警展示和实时状态监控。

3.  **数据流**:
    *   `GPS设备 -> HTTP POST -> 后端API (加入后台任务) -> [异步处理: 数据库存储 & 实时分析 -> WebSocket推送] -> 前端UI更新`

---

## 4. 环境准备

1.  **Python环境**: 推荐使用 Python 3.9+。可使用 [Miniconda](https://docs.conda.io/en/latest/miniconda.html) 或 [Anaconda](https://www.anaconda.com/) 管理环境。
2.  **安装Python依赖**:
    *   项目的所有依赖都已记录在 `requirements.txt` 文件中。打开终端并运行以下命令来一键安装所有必需的库：
    ```bash
    pip install -r requirements.txt
    ```
    *   **注意**: 如果 `geopandas` 安装遇到问题，建议先通过 `conda install geopandas` 安装，然后再运行上述 `pip` 命令。

---

## 5. 操作说明

### **步骤 1: 配置与初始化 (首次运行)**

1.  **配置渔区**:
    *   打开 `config.json` 文件。
    *   在 `monitoring_parameters` 部分，将 `default_fishing_zones` 的值修改为您的渔区Shapefile文件的**绝对或相对路径**。
2.  **转换地理数据**:
    *   打开一个终端，运行以下命令将Shapefile转换为前端可用的GeoJSON格式：
        ```bash
        python Scripts/convert_geojson.py
        ```
    *   此脚本会将生成的 `fishing_zones.geojson` 文件保存到 `frontend/data/` 目录。

### **步骤 2: 启动后端服务器**

1.  在项目根目录打开一个终端。
2.  运行后端服务器：
    ```bash
    python backend/main.py
    ```
    *   服务器首次启动时，会自动在项目根目录创建 `database.db` 文件。
    *   保持此终端窗口打开。

### **步骤 3: 打开前端Web页面**

1.  在您的Web浏览器中直接打开 `frontend/index.html` 文件 (通过 `file://` 协议即可)。
    *   页面加载后会自动连接到后端服务器。

### **步骤 4: 启动手动GPS模拟器 (用于测试)**

1.  打开**另一个新的终端**。
2.  运行手动GPS模拟器：
    ```bash
    python Scripts/ManualGPSSimulator.py
    ```
3.  **操作模拟器**:
    *   在模拟器GUI中，可以为不同的船只设置 `船只ID` (例如 `BOAT-001`) 和 `船只名称`。
    *   点击“开始发送”，模拟器会通过HTTP请求将数据发送到后端。
    *   您可以打开多个模拟器实例，或在同一个模拟器中更改ID后重启发送，来模拟多艘船。

### **步骤 5: 在前端进行交互**

1.  **实时查看**: 在右侧边栏的“船只列表”中，您会看到所有在线的船只。
2.  **选择船只**: 点击列表中的任意船只，地图会自动聚焦，右侧的状态面板会显示其详细信息。
3.  **查询历史**: 在左侧边栏的“历史查询”面板中选择船只和时间范围，点击“查询”按钮，即可在地图上查看历史轨迹和预警点。

---

## 6. 故障排除

*   **WebSocket连接失败**:
    *   确保后端服务器 (`python backend/main.py`) 正在运行且没有报错。
    *   检查浏览器控制台是否有CORS或其他网络错误。
*   **`ModuleNotFoundError`**: 确保所有Python依赖都已通过 `pip install` 正确安装。
*   **GeoJSON文件未找到**: 确保您已成功运行 `python Scripts/convert_geojson.py` 脚本。
*   **HTTP请求失败 (模拟器)**: 确保后端服务器 (`python backend/main.py`) 正在运行，并且模拟器中的服务器地址 (`http://localhost:8000/api/gps_data`) 是正确的。
